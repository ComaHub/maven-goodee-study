<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dev.coma.study.board.qna.QnaDAO">
	<resultMap type="QnaDTO" id="qnaResultMap">
		<id property="boardNum" column="board_num" />
		<result property="boardTitle" column="board_title" />
		<result property="boardContent" column="board_content" />
		<result property="boardWriter" column="board_writer" />
		<result property="boardDate" column="board_date" />
		<result property="boardHit" column="board_hit" />
		<result property="boardRef" column="board_ref" />
		<result property="boardStep" column="board_step" />
		<result property="boardDepth" column="board_depth" />
		
		<collection property="boardFileDTOs" javaType="java.util.List" ofType="BoardFileDTO">
			<result property="fileNum" column="file_num" />
			<result property="originName" column="origin_name" />
			<result property="savedName" column="saved_name" />
		</collection>
	</resultMap>
	
	<sql id="commonSearch">
		<where>
			<choose>
				<when test="kind == 'k2'">
					board_content
				</when>
				<when test="kind == 'k3'">
					board_writer
				</when>
				<otherwise>
					board_title
				</otherwise>
			</choose>
			LIKE CONCAT('%', #{ keyword }, '%')
		</where>		
	</sql>
	
	<select id="selectBoardList" parameterType="Pager" resultType="QnaDTO">
		SELECT
				*
		FROM qna
		<include refid="commonSearch"></include>
		ORDER BY board_ref DESC, board_step ASC
		LIMIT #{startIdx}, #{endIdx}
	</select>
	
	<select id="selectTotalCount" resultType="Long">
		SELECT
				COUNT(board_num)
		FROM qna
		<include refid="commonSearch"></include>
	</select>
	
	<select id="selectBoardDetail" parameterType="QnaDTO" resultMap="qnaResultMap">
		SELECT
				*
		FROM qna Q
		LEFT OUTER JOIN qna_attach QA USING (board_num)
		<where>
			board_num = #{boardNum}
		</where>
	</select>
	
	<select id="selectBoardAttach" parameterType="BoardFileDTO" resultType="BoardFileDTO">
		SELECT
				*
		FROM qna_attach
		<where>
			file_num = #{fileNum}
		</where>
	</select>
	
	<insert id="insertBoard" parameterType="QnaDTO" useGeneratedKeys="true" keyProperty="boardNum">
		INSERT INTO qna (board_title, board_content, board_writer, board_ref, board_step, board_depth)
		VALUES (
				#{boardTitle}
			, #{boardContent}
			, #{boardWriter}
			<choose>
				<when test='boardRef != null and boardStep != null and boardDepth != null'>
			, #{boardRef}
			, #{boardStep}
			, #{boardDepth}
				</when>
				<otherwise>
			, 0
			, 0
			, 0
				</otherwise>
			</choose>
		)
	</insert>
	
	<insert id="insertBoardAttach" parameterType="BoardFileDTO">
		INSERT INTO qna_attach (board_num, origin_name, saved_name)
		VALUE (#{boardNum}, #{originName}, #{savedName})
	</insert>
	
	<update id="updateBoard" parameterType="QnaDTO">
		UPDATE qna
		SET
				board_title = #{boardTitle}
			, board_content = #{boardContent}
			, board_writer = #{boardWriter}
		<where>
			board_num = #{boardNum}
		</where>
	</update>
	
	<update id="updateRef" parameterType="QnaDTO">
		UPDATE qna
		SET
				board_ref = #{boardNum}
		<where>
			board_num = #{boardNum}
		</where>
	</update>
	
	<update id="updateReplyStep" parameterType="QnaDTO">
		UPDATE qna
		SET
			board_step = board_step + 1
		<where>
			board_ref = #{boardRef} AND board_step > #{boardStep}
		</where>
	</update>
	
	<update id="deleteBoard" parameterType="Long">
		UPDATE qna
		SET
				board_title = ""
			, board_content = ""
			, board_writer = ""
		<where>
			board_num = #{boardNum}
		</where>
	</update>
	
	<delete id="deleteBoardAttach" parameterType="Long">
		DELETE FROM qna_attach
		<where>
			board_num = #{boardNum}
		</where>
	</delete>
	
	<delete id="deleteBoardAttachOne" parameterType="Long">
		DELETE FROM qna_attach
		<where>
			file_num = #{fileNum}
		</where>
	</delete>
</mapper>